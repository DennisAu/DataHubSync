# DataHubSync - 需求文档 (基于 Cloudflare Tunnel)

> **项目原名**：股票数据分发系统  
> **项目路径**：`/opt/projects/DataHubSync`

## 1. 项目背景

### 1.1 现状
- **数据源**：Windowshub电脑，存储高质量A股历史数据（日频，高开低收成交量等）
- **数据规模**：约5000+只股票，每只股票全历史数据
- **数据更新**：每日收盘后增量更新
- **网络环境**：无公网IP，位于家庭/办公内网

### 1.2 需求
- **数据消费者**：6台量化服务器
  - 3台：与hub电脑同局域网（内网直连）
  - 3台：异地机房（分别位于北京、日本、美国）
- **传输要求**：单向传输（仅hub电脑→客户端）
- **实时性**：日频数据，每日同步1-2次即可
- **可靠性**：允许偶尔失败回退到旧数据，但需记录日志

### 1.3 约束条件
| 约束项 | 要求 |
|--------|------|
| **预算** | 免费或 < ¥50/月 |
| **客户端侵入性** | 优先零安装，日本/美国服务器尽量不改动 |
| **hub电脑侵入性** | 可接受轻量级软件（单二进制文件） |
| **维护成本** | 优先开箱即用，减少手动运维 |
| **跨国传输** | 日本/美国访问需保证基本速度 |

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              hub电脑 (Windows)                                 │
│                          数据源 + Cloudflare Tunnel                          │
│  ┌─────────────────┐      ┌─────────────────────────┐                      │
│  │ 数据文件夹       │◄────│ Python HTTP文件服务器    │                      │
│  │ (本地CSV文件)    │      │ (零依赖，单文件)         │                      │
│  └─────────────────┘      └───────────┬─────────────┘                      │
│                                       │                                     │
│                           ┌───────────┴───────────┐                         │
│                           │   cloudflared 客户端   │                         │
│                           │   (单二进制，~10MB)    │                         │
│                           └───────────┬───────────┘                         │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Cloudflare 全球网络                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ 北京节点     │  │ 日本节点     │  │ 美国节点     │  │ 其他边缘节点         │ │
│  │ (就近接入)   │  │ (就近接入)   │  │ (就近接入)   │  │ (智能路由)          │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘ │
└─────────┼────────────────┼────────────────┼────────────────────┼────────────┘
          │                │                │                    │
          ▼                ▼                ▼                    ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   客户端1        │ │   客户端4        │ │   客户端5        │ │   客户端6        │
│  (局域网)        │ │  (北京机房)      │ │  (日本)          │ │  (美国)          │
│                 │ │                 │ │                 │ │                 │
│ • 直接访问        │ │ • 通过CF节点      │ │ • 通过CF节点      │ │ • 通过CF节点      │
│ • 无需安装软件    │ │ • 无需安装软件    │ │ • 无需安装软件    │ │ • 无需安装软件    │
│ • curl/wget     │ │ • curl/wget     │ │ • curl/wget     │ │ • curl/wget     │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
┌─────────────────┐ ┌─────────────────┐
│   客户端2        │ │   客户端3        │
│  (局域网)        │ │  (局域网)        │
│                 │ │                 │
│ • 同客户端1      │ │ • 同客户端1      │
└─────────────────┘ └─────────────────┘
```

### 2.2 组件说明

| 组件 | 位置 | 技术 | 作用 |
|------|------|------|------|
| **数据服务器** | hub电脑 | Python HTTP (标准库) | 提供文件下载服务 |
| **内网穿透** | hub电脑 | cloudflared | 将本地服务暴露到公网 |
| **CDN/入口** | Cloudflare | Cloudflare Tunnel | 全球边缘节点接入，HTTPS加密 |
| **客户端** | 6台服务器 | curl/wget/Python | 通过HTTPS拉取数据 |

### 2.3 为什么选Cloudflare Tunnel

| 对比维度 | Tailscale方案 | Cloudflare Tunnel方案 |
|----------|---------------|----------------------|
| **hub电脑** | 安装Tailscale客户端 | 安装cloudflared（单二进制，更轻） |
| **局域网3台** | 必须安装Tailscale | **零安装**，直接HTTPS访问 |
| **异地3台** | 必须安装Tailscale | **零安装**，直接HTTPS访问 |
| **跨国速度** | DERP中继 | Cloudflare全球CDN优化 |
| **客户端配置** | 需登录Tailscale账号 | 无需任何配置 |
| **维护成本** | 管理6台设备 | 主要维护hub电脑 |
| **费用** | 免费版20台设备 | 完全免费，无限流量 |

**核心优势**：
1. **客户端零负担**：日本/美国服务器不用装任何软件
2. **全球加速**：CF在日本美国有节点，跨国传输快
3. **极简维护**：只需管理hub电脑的cloudflared
4. **免费**：完全免费，无流量限制

### 2.4 双轨预留架构设计

**设计目标**：当前使用 Cloudflare Tunnel，但架构上预留 Tailscale 切换能力，未来可无缝迁移。

**架构图**：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              hub电脑 (Windows)                                 │
│                                                                            │
│  ┌─────────────────┐      ┌─────────────────────────┐    ┌──────────────┐ │
│  │ 数据文件夹       │◄────│ Python HTTP文件服务器    │◄───│ 统一配置层    │ │
│  │ (本地CSV文件)    │      │ (零依赖，单文件)         │    │ (环境抽象)    │ │
│  └─────────────────┘      └───────────┬─────────────┘    └──────────────┘ │
│                                       │                                     │
│                    ┌──────────────────┴──────────────────┐                  │
│                    │           网络层 (可切换)            │                  │
│                    │  ┌─────────────────────────────┐   │                  │
│   ┌──────────────┐ │  │ 当前: Cloudflare Tunnel     │   │                  │
│   │  预留槽位    │ │  │ • cloudflared 客户端        │   │                  │
│   │ (Tailscale)  │ │  │ • 公网域名访问              │   │                  │
│   │ • 随时启用   │ │  └─────────────────────────────┘   │                  │
│   └──────────────┘ │  ┌─────────────────────────────┐   │                  │
│                    │  │ 预留: Tailscale VPN         │   │                  │
│                    │  │ • 内网直连                  │   │                  │
│                    │  │ • MagicDNS                  │   │                  │
│                    │  └─────────────────────────────┘   │                  │
│                    └─────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
            ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
            │ Cloudflare  │     │ Split DNS   │     │ Tailscale   │
            │ 全球网络    │     │ (预留)      │     │ MagicDNS    │
            └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
                   │                    │                    │
        ┌──────────┴──────────┐         │         ┌──────────┴──────────┐
        ▼                     ▼         ▼         ▼                     ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   客户端1-6    │     │   客户端1-6    │     │   客户端1-6    │     │   客户端1-6    │
│  (CF方案)     │     │  (CF方案)     │     │  (TS方案)     │     │  (TS方案)     │
│               │     │               │     │               │     │               │
│ • 零安装      │     │ • 零安装      │     │ • 需安装TS    │     │ • 需安装TS    │
│ • 域名访问    │     │ • 域名访问    │     │ • 内网IP访问  │     │ • 内网IP访问  │
└───────────────┘     └───────────────┘     └───────────────┘     └───────────────┘
```

**预留策略**：

| 层面 | 当前实现 | 预留措施 | 切换成本 |
|------|----------|----------|----------|
| **配置管理** | 硬编码域名 | 环境变量抽象 `SERVER_URL` | 修改1个变量 |
| **部署架构** | cloudflared 容器 | Docker profile 隔离 | 一条命令切换 |
| **客户端** | HTTPS 访问 | 统一客户端封装，协议自适应 | 无需改动 |
| **DNS** | Cloudflare 域名 | Split DNS 预配置 | 修改DNS记录 |
| **访问控制** | 公网开放 | 内网IP白名单预留 | 调整防火墙 |

**切换触发条件**：
1. Cloudflare 服务不稳定或受限
2. 需要更高传输性能（P2P直连）
3. 安全性要求提升（需内网隔离）
4. 客户端数量增加，管理成本可控

---

## 3. 数据流设计

### 3.1 同步流程

```
定时触发（每日9:01 & 17:00）
        │
        ▼
┌───────────────┐
│  1. 检查数据源  │
│  hub电脑数据目录  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  2. 生成清单   │
│  (文件名+MD5)  │
└───────┬───────┘
        │
        ▼
┌───────────────┐     ┌──────────────────────────────────────────┐
│  3. 客户端请求 │────▶│  通过 https://stock-data.yourdomain.com  │
│  /api/manifest │     │  Cloudflare Tunnel 路由到hub电脑            │
└───────┬───────┘     └──────────────────────────────────────────┘
        │
        ▼
┌───────────────┐
│  4. 比对差异   │
│  (本地vs远程)  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  5. 增量下载   │
│  仅下载变更文件 │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  6. 运行指标   │
│  run_indicators│
└───────────────┘
```

### 3.2 API设计

| 端点 | 方法 | 说明 | 示例 |
|------|------|------|------|
| `/api/info` | GET | 服务器信息 | 文件总数、数据目录 |
| `/api/manifest` | GET | 数据清单 | 所有文件列表+MD5+大小 |
| `/data/{filepath}` | GET | 下载文件 | 单文件下载，断点续传支持 |

### 3.3 增量同步机制

1. **hub电脑端**：每日生成manifest（JSON格式），包含所有文件的MD5
2. **客户端**：下载manifest，与本地文件MD5比对
3. **差异计算**：仅下载MD5不匹配的文件
4. **并发下载**：多线程并行下载，提高效率

---

## 4. 部署要求

### 4.1 hub电脑端（数据源）

**硬件要求**：
- Windows 7/10/11
- 内存：4GB+（Python HTTP服务很轻量）
- 磁盘：数据目录可用空间

**软件要求**：
- Python 3.6+（标准库即可，无需pip安装包）
- cloudflared 二进制文件（从Cloudflare官网下载）

**网络要求**：
- 能访问互联网（用于连接Cloudflare）
- 无需公网IP
- 上传带宽：根据数据增量决定（通常<10MB/日）

**配置步骤**：
1. 安装Python
2. 下载cloudflared并安装为Windows服务
3. 创建Tunnel并绑定域名
4. 部署Python HTTP服务
5. 配置开机自启

### 4.2 客户端端（6台服务器）

**硬件要求**：
- 任意Linux发行版
- 能访问互联网（连接Cloudflare）

**软件要求**：
- Python 3.6+（用于运行同步脚本，标准库即可）
- curl/wget（用于测试）

**网络要求**：
- 能访问Cloudflare（全球可访问）
- 下载带宽：根据数据量决定

**配置步骤**：
1. 部署同步脚本
2. 配置定时任务（crontab）
3. （可选）与指标系统集成

---

## 5. 预算分析

### 5.1 成本构成

| 项目 | 方案 | 月费用 | 说明 |
|------|------|--------|------|
| **Cloudflare Tunnel** | 免费版 | ¥0 | 无限隧道，无限流量 |
| **域名** | 可选 | ¥0-10 | 可用免费二级域名，或购买域名 |
| **服务器** | 现有 | ¥0 | 使用已有6台服务器 |
| **网络流量** | Cloudflare | ¥0 | 免费CDN，无流量限制 |
| **对象存储** | 不使用 | ¥0 | 不走OSS，省流量费 |

**总计：¥0/月（完全免费）**

### 5.2 流量估算

假设：
- 全量数据：5000只股票 × 500KB/只 = 2.5GB（首次）
- 每日增量：5000只 × 1KB/只 = 5MB/日
- 每月增量：5MB × 30 = 150MB

**结论**：远低于Cloudflare免费限额，完全免费。

---

## 6. 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| **Cloudflare服务中断** | 低 | 高 | 可快速切换到备份方案（手动上传/对象存储） |
| **hub电脑关机/断网** | 中 | 中 | 客户端使用本地缓存数据，记录日志提醒 |
| **数据损坏/不一致** | 低 | 高 | MD5校验，失败自动重试，日志记录 |
| **跨国传输慢** | 低 | 中 | Cloudflare全球CDN优化，可接受延迟 |
| **cloudflared进程崩溃** | 低 | 高 | Windows服务自动重启，监控告警 |

---

## 7. 实施计划

### 阶段1：POC验证（1-2天）
- [ ] hub电脑安装cloudflared，创建Tunnel
- [ ] 部署Python HTTP服务（单机测试）
- [ ] 1台客户端（局域网）测试同步
- [ ] 1台客户端（异地）测试同步
- [ ] 验证跨国传输速度

### 阶段2：局域网部署（1天）
- [ ] 3台局域网客户端部署同步脚本
- [ ] 配置定时任务
- [ ] 验证每日自动同步

### 阶段3：异地部署（1天）
- [ ] 3台异地客户端（含日本、美国）部署
- [ ] 测试跨国传输稳定性
- [ ] 与指标系统集成

### 阶段4：优化（持续）
- [ ] 添加监控告警
- [ ] 优化同步速度（并发数调整）
- [ ] 完善日志系统

---

## 8. 待决策事项

| 事项 | 选项 | 建议 |
|------|------|------|
| **域名** | A. 使用Cloudflare免费二级域名<br>B. 购买自己的域名 | 推荐B（更专业，可控） |
| **数据压缩** | A. 不压缩（CSV已压缩）<br>B. 启用gzip传输 | 推荐A（减少CPU开销） |
| **同步时机** | A. hub电脑定时推送<br>B. 客户端定时拉取 | 推荐B（解耦，更可控） |
| **失败处理** | A. 跳过继续<br>B. 重试3次后告警<br>C. 立即停止 | 推荐B（平衡可靠性和稳定性） |

---

## 9. 附录

### 9.1 参考链接
- Cloudflare Tunnel文档：https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/
- cloudflared下载：https://github.com/cloudflare/cloudflared/releases

### 9.2 相关脚本
- `stock_data_hub_server.py` - hub电脑端HTTP服务
- `stock_data_sync_client.py` - 客户端同步脚本

### 9.3 更新记录
| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2025-02 | 初始版本，基于Cloudflare Tunnel方案 |

---

**下一步行动**：确认需求文档后，开始POC验证（hub电脑安装cloudflared并创建Tunnel）。
