# DataHubSync - é¡¹ç›®å¾…åŠæ¸…å• (v2.1 æ–°é²œåº¦è§„åˆ™è°ƒæ•´)

> **é¡¹ç›®è·¯å¾„**ï¼šä»“åº“æ ¹ç›®å½•ï¼ˆhub è¿è¡Œäº Windowsï¼Œå®¢æˆ·ç«¯ç¤ºä¾‹ä¸º Linuxï¼‰  
> **è®¾è®¡ç‰ˆæœ¬**ï¼šv2.1 - æ–°é²œåº¦è§„åˆ™è°ƒæ•´  
> **æ›´æ–°æ—¥æœŸ**ï¼š2026-02-04

---

## âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| Cloudflare Tunnel åˆ›å»º | âœ… | UUID: `829bd79d-7e4f-4177-8778-2985f3d4120c` |
| DNS é…ç½® | âœ… | `data.quantrade.fun` æŒ‡å‘ Tunnel |
| cloudflared æœåŠ¡åŒ– | âœ… | Windows æœåŠ¡ `Cloudflared` å·²è¿è¡Œ |
| ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ v2.0 | âœ… | æç®€è®¾è®¡ï¼Œé¢„æ‰“åŒ…æ–¹æ¡ˆ |

---

## ğŸ“‹ å¾…åŠä»»åŠ¡ (æŒ‰ä¼˜å…ˆçº§)

### Phase 1: hub ç«¯æ ¸å¿ƒåŠŸèƒ½

#### ä»»åŠ¡1.1: æ–°é²œåº¦æ£€æµ‹å™¨
**ç›®æ ‡**: å®ç°æ•°æ®è¡¨ï¼ˆdatasetçº§åˆ«ï¼‰æ–°é²œåº¦æ£€æµ‹ï¼ŒåŸºäº mtime åˆ†é’Ÿå¤šæ•°åˆ¤å®šï¼Œnewer_ratio>=0.30ï¼Œ10åˆ†é’Ÿè½®è¯¢ï¼Œ60ç§’é˜²æŠ–

**éªŒæ”¶æ ‡å‡†**:
- [ ] æŒ‰ dataset çº§åˆ«æ‰«ææ•°æ®ç›®å½•ï¼ŒåŸºäºæ–‡ä»¶ mtime çš„åˆ†é’Ÿç²’åº¦ç»Ÿè®¡
- [ ] ä»¥å¤šæ•°åˆ†é’Ÿï¼ˆmajority-minuteï¼‰ä½œä¸ºå½“å‰æ•°æ®ç‰ˆæœ¬ï¼ˆå¹¶åˆ—æ—¶å–æœ€æ–°åˆ†é’Ÿï¼‰
- [ ] è®¡ç®— `newer_ratio`ï¼ˆå¤šæ•°åˆ†é’Ÿæ–‡ä»¶æ•° / æ€»æ–‡ä»¶æ•°ï¼‰
- [ ] `newer_ratio >= 0.30` æ—¶ï¼Œå¯åŠ¨ 60 ç§’é˜²æŠ–è§‚å¯Ÿ
- [ ] 60 ç§’å†… `newer_ratio` ç¨³å®šï¼ˆä¸å†å˜åŒ–ï¼‰â†’ è§¦å‘æ‰“åŒ…
- [ ] 60 ç§’å†… `newer_ratio` ä»åœ¨å˜åŒ– â†’ è·³è¿‡ï¼Œç­‰ä¸‹ä¸€è½®
- [ ] æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥

**å…³é”®é€»è¾‘**:
```python
majority_minute = get_majority_minute(file_mtime_minutes)
newer_ratio = count_at_minute(majority_minute) / total_files

if newer_ratio >= 0.30:
    # å¯åŠ¨60ç§’é˜²æŠ–
    time.sleep(60)
    newer_ratio_2 = recalculate()
    
    if abs(newer_ratio_2 - newer_ratio) < 0.01:  # åŸºæœ¬ç¨³å®šï¼ˆå˜åŒ– < 1%ï¼‰
        trigger_packaging()
    else:
        # ä»åœ¨å˜åŒ–ï¼Œè·³è¿‡
        pass
```

#### ä»»åŠ¡1.2: å¼‚æ­¥æ‰“åŒ…å™¨
**ç›®æ ‡**: åå°æ‰“åŒ…æ•°æ®ç›®å½•ä¸º zip

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡HTTPæœåŠ¡
- [ ] æ‰“åŒ…åˆ° `.cache/{dataset}_{timestamp}.zip`
- [ ] å®Œæˆåæ›´æ–° `last_updated` çŠ¶æ€
- [ ] åªä¿ç•™æœ€è¿‘2ä¸ªç‰ˆæœ¬çš„ zip

#### ä»»åŠ¡1.3: HTTP æœåŠ¡å™¨
**ç›®æ ‡**: æä¾›ä¸¤ä¸ªç«¯ç‚¹

**éªŒæ”¶æ ‡å‡†**:
- [ ] `GET /api/datasets` - è¿”å›æ•°æ®è¡¨åˆ—è¡¨å’Œ last_updated
- [ ] `GET /package/{dataset}.zip` - è¿”å› zip æ–‡ä»¶æµ
- [ ] æ”¯æŒ Range è¯·æ±‚ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰
- [ ] æ—¥å¿—è®°å½•

#### ä»»åŠ¡1.4: é…ç½®ç®¡ç†
**ç›®æ ‡**: é…ç½®æ–‡ä»¶å’Œç›®å½•ç»“æ„

**éªŒæ”¶æ ‡å‡†**:
- [ ] `config.yaml` - ç«¯å£ã€æ•°æ®ç›®å½•ã€é˜ˆå€¼ç­‰
- [ ] `datasets_state.json` - å„æ•°æ®è¡¨ last_updated çŠ¶æ€
- [ ] ç›®å½•ç»“æ„:
  ```
  C:\DataHubSync\
  â”œâ”€â”€ config.yaml
  â”œâ”€â”€ datasets_state.json
  â”œâ”€â”€ server.py
  â”œâ”€â”€ src\           # æºç ç›®å½•
  â”œâ”€â”€ .cache\        # zip ç¼“å­˜
  â””â”€â”€ logs\          # æ—¥å¿—
  ```

#### ä»»åŠ¡1.5: Windows æœåŠ¡åŒ–
**ç›®æ ‡**: hubç”µè„‘å¼€æœºè‡ªå¯

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä½¿ç”¨ nssm åŒ…è£…ä¸º Windows æœåŠ¡
- [ ] å¼€æœºè‡ªåŠ¨å¯åŠ¨
- [ ] å´©æºƒè‡ªåŠ¨é‡å¯
- [ ] æ—¥å¿—è½®è½¬

---

### Phase 2: å®¢æˆ·ç«¯åŒæ­¥è„šæœ¬

#### ä»»åŠ¡2.1: åŒæ­¥æ ¸å¿ƒé€»è¾‘
**ç›®æ ‡**: Python åŒæ­¥è„šæœ¬

**éªŒæ”¶æ ‡å‡†**:
- [ ] è¯·æ±‚ `/api/datasets` è·å–è¿œç¨‹çŠ¶æ€
- [ ] å¯¹æ¯”æœ¬åœ° `last_updated` æ—¶é—´æˆ³
- [ ] å¦‚æœè¿œç¨‹æ›´æ–°ï¼Œä¸‹è½½ zip
- [ ] è§£å‹è¦†ç›–æœ¬åœ°æ•°æ®
- [ ] æ›´æ–°æœ¬åœ°æ—¶é—´æˆ³
- [ ] åŒæ­¥è„šæœ¬å…¼å®¹ Linux/Windowsï¼ˆè·¯å¾„æŒ‰ç³»ç»Ÿé€‚é…ï¼‰
- [ ] æ”¯æŒ curl -C æ–­ç‚¹ç»­ä¼ 

#### ä»»åŠ¡2.2: å®¢æˆ·ç«¯é…ç½®
**ç›®æ ‡**: é…ç½®æ–‡ä»¶

**éªŒæ”¶æ ‡å‡†**:
- [ ] `config.yaml` - hub URLã€æœ¬åœ°æ•°æ®ç›®å½•ç­‰
- [ ] `.last_sync.json` - å„æ•°æ®è¡¨åŒæ­¥æ—¶é—´æˆ³

#### ä»»åŠ¡2.3: éƒ¨ç½²å’Œå®šæ—¶ä»»åŠ¡
**ç›®æ ‡**: Linux/Windows å®¢æˆ·ç«¯éƒ¨ç½²

**éªŒæ”¶æ ‡å‡†**:
- [ ] Linux: éƒ¨ç½²åˆ° `/opt/datahubsync/`
- [ ] Linux: `sync.sh` æ‰§è¡Œè„šæœ¬
- [ ] Linux: crontab: `15 8 * * *` (æ¯æ—¥8:15)
- [ ] Linux: æ—¥å¿—è¾“å‡ºåˆ° `logs/sync.log`
- [ ] Windows: æä¾›ç­‰ä»·è¿è¡Œè„šæœ¬ï¼ˆå¦‚ sync.ps1 æˆ– .batï¼‰
- [ ] Windows: ä»»åŠ¡è®¡åˆ’ç¨‹åºå®šæ—¶æ‰§è¡Œï¼ˆç¤ºä¾‹ï¼‰

---

### Phase 3: æµ‹è¯•éªŒè¯

#### ä»»åŠ¡3.1: hub ç«¯æµ‹è¯•
- [ ] æ–°é²œåº¦æ£€æµ‹æ­£ç¡®ï¼ˆ30%é˜ˆå€¼ï¼‰
- [ ] é˜²æŠ–æœºåˆ¶æœ‰æ•ˆï¼ˆ60ç§’è§‚å¯Ÿï¼‰
- [ ] å®šæ—¶æ£€æŸ¥æ­£å¸¸ï¼ˆ10åˆ†é’Ÿé—´éš”ï¼‰
- [ ] HTTP ç«¯ç‚¹å¯ç”¨
- [ ] zip ä¸‹è½½æ­£å¸¸

#### ä»»åŠ¡3.2: å®¢æˆ·ç«¯æµ‹è¯•
- [ ] é¦–æ¬¡åŒæ­¥ï¼ˆç©ºç›®å½•ï¼‰
- [ ] å¢é‡åŒæ­¥ï¼ˆå·²æ˜¯æœ€æ–°ï¼‰
- [ ] æ›´æ–°åŒæ­¥ï¼ˆæœ‰æ–°ç‰ˆæœ¬ï¼‰
- [ ] æ–­ç‚¹ç»­ä¼ ï¼ˆä¸­æ–­åæ¢å¤ï¼‰

#### ä»»åŠ¡3.3: é›†æˆæµ‹è¯•
- [ ] å®Œæ•´æµç¨‹ï¼šæ•°æ®æ›´æ–° â†’ æ–°é²œåº¦æ£€æµ‹ â†’ æ‰“åŒ… â†’ å®¢æˆ·ç«¯åŒæ­¥
- [ ] 6å°å®¢æˆ·ç«¯å¹¶å‘ä¸‹è½½
- [ ] å®¢æˆ·ç«¯æ•°é‡ä»¥ 6 å°ä¸ºå‡†ï¼ˆPhase 4 è¡¥é½æ¸…å•ï¼‰
- [ ] 8:15 å‰å®ŒæˆåŒæ­¥

---

### Phase 4: å¤šå®¢æˆ·ç«¯éƒ¨ç½²

**ç›®æ ‡**: éƒ¨ç½²åˆ°6å°å®¢æˆ·ç«¯

**æœåŠ¡å™¨åˆ—è¡¨**:
- [ ] å®¢æˆ·ç«¯1: å±€åŸŸç½‘
- [ ] å®¢æˆ·ç«¯2: å±€åŸŸç½‘
- [ ] å®¢æˆ·ç«¯3: å±€åŸŸç½‘
- [ ] å®¢æˆ·ç«¯4: åŒ—äº¬æœºæˆ¿
- [ ] å®¢æˆ·ç«¯5: æ—¥æœ¬æœºæˆ¿
- [ ] å®¢æˆ·ç«¯6: ç¾å›½æœºæˆ¿

**æ¯å°æ‰§è¡Œ**:
1. å¤åˆ¶åŒæ­¥è„šæœ¬
2. ä¿®æ”¹ `config.yaml` æœ¬åœ°ç›®å½•
3. é…ç½® crontab
4. æµ‹è¯•åŒæ­¥

---

## ğŸ“‚ ç›®å½•ç»“æ„

### hub ç”µè„‘ (Windows)
```
C:\DataHubSync\
â”œâ”€â”€ config.yaml                    # é…ç½®
â”œâ”€â”€ datasets_state.json            # æ•°æ®è¡¨çŠ¶æ€
â”œâ”€â”€ server.py                      # å…¥å£
â”œâ”€â”€ src\
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ freshness_checker.py       # æ–°é²œåº¦æ£€æµ‹
â”‚   â”œâ”€â”€ packager.py                # å¼‚æ­¥æ‰“åŒ…
â”‚   â”œâ”€â”€ http_server.py             # HTTPæœåŠ¡
â”‚   â””â”€â”€ scheduler.py               # å®šæ—¶è°ƒåº¦
â””â”€â”€ logs\                          # æ—¥å¿—
    â”œâ”€â”€ server.log
    â””â”€â”€ freshness.log

F:\xbx_datas\                      # æ•°æ®ç›®å½•
â”œâ”€â”€ stock-trading-data-pro\
â”œâ”€â”€ stock-fin-data-xbx\
â”œâ”€â”€ stock-etf-trading-data\
â””â”€â”€ .cache\                        # zip ç¼“å­˜
    â”œâ”€â”€ stock-trading-data-pro_20250204_201500.zip
    â””â”€â”€ stock-fin-data-xbx_20250204_070500.zip
```

### å®¢æˆ·ç«¯ (Linux/Windows)
> å®¢æˆ·ç«¯ç¤ºä¾‹ä¸º Linux è·¯å¾„ï¼ŒWindows è¯·æŒ‰å®é™…ç›˜ç¬¦æ›¿æ¢ã€‚
```
/opt/datahubsync/
â”œâ”€â”€ config.yaml                    # é…ç½®
â”œâ”€â”€ .last_sync.json                # æœ¬åœ°åŒæ­¥æ—¶é—´æˆ³
â”œâ”€â”€ sync.py                        # åŒæ­¥è„šæœ¬
â”œâ”€â”€ sync.sh                        # æ‰§è¡Œè„šæœ¬
â””â”€â”€ logs/
    â””â”€â”€ sync.log

/data/                             # æ•°æ®ç›®å½•
â”œâ”€â”€ stock-trading-data-pro/
â”œâ”€â”€ stock-fin-data-xbx/
â””â”€â”€ ...
```

---

## ğŸ”§ å…³é”®é…ç½®

### hub ç«¯ config.yaml
```yaml
server:
  port: 8080
  data_root: "F:\\xbx_datas"
  cache_dir: "F:\\xbx_datas\\.cache"

datasets:
  - name: "stock-trading-data-pro"
    path: "stock-trading-data-pro"
    newer_ratio_threshold: 0.30
  - name: "stock-fin-data-xbx"
    path: "stock-fin-data-xbx"
    newer_ratio_threshold: 0.30
  - name: "stock-etf-trading-data"
    path: "stock-etf-trading-data"
    newer_ratio_threshold: 0.30

check:
  interval_minutes: 10
  debounce_seconds: 60

packaging:
  format: "zip"
  keep_versions: 2
```

### å®¢æˆ·ç«¯ config.yaml
```yaml
hub:
  url: "https://data.quantrade.fun"
  timeout: 300

datasets:
  - name: "stock-trading-data-pro"
    local_dir: "/data/stock-trading-data-pro"
  - name: "stock-fin-data-xbx"
    local_dir: "/data/stock-fin-data-xbx"

logging:
  level: INFO
  file: "logs/sync.log"
```

---

## ğŸ¯ æ£€æŸ¥æ¸…å•

### æ¯æ—¥è¿è¡Œæ£€æŸ¥
- [ ] 20:00 æ•°æ®æ›´æ–°åï¼Œ30åˆ†é’Ÿå†…å®Œæˆæ‰“åŒ…
- [ ] æ¬¡æ—¥ 8:15 å‰æ‰€æœ‰å®¢æˆ·ç«¯åŒæ­¥å®Œæˆ
- [ ] æ—¥å¿—æ— é”™è¯¯

### ç›‘æ§é¡¹
- [ ] hub ç«¯æœåŠ¡è¿è¡ŒçŠ¶æ€
- [ ] æ–°é²œåº¦æ£€æµ‹æ˜¯å¦æ­£å¸¸
- [ ] zip åŒ…ç”Ÿæˆæ—¶é—´
- [ ] å®¢æˆ·ç«¯åŒæ­¥æ—¶é—´

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [éœ€æ±‚æ–‡æ¡£](requirements/REQUIREMENTS_CLOUDFLARE_TUNNEL.md)
- [è®¾è®¡æ–‡æ¡£ v2.0](requirements/SOFTWARE_DESIGN_CLOUDFLARE_TUNNEL.md)
- [é¡¹ç›® README](README.md)

---

*æ›´æ–°æ—¶é—´: 2026-02-04*
